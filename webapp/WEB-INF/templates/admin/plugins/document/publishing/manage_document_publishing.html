<#if document?exists>
<@pageContainer>
    <@pageColumn> 
        <@pageHeader title='#i18n{document.manage_document_publishing.labelPublishTitle}'>
			<@aButton href='jsp/admin/plugins/document/ManageDocuments.jsp?id_space_filter=${document.spaceId}' title='#i18n{document.preview_document.space}' buttonIcon='folder-open' />
			<@button type='button' class='btn-action' buttonIcon='dots-vertical fs-2 ms-3' dropdownMenu=true>
			<#list document.actions?sort_by("idAction") as action>
				<#if action.url?has_content>
					<@link href='${action.url}id_document=${document.id}&id_action=${action.idAction}' class='dropdown-item'><@icon style='${action.iconUrl}' title=action.description />${action.name}</@link>
				</#if>
			</#list>
			</@button>
		</@pageHeader>
		<@row>
			<@columns lg=2>
				<@box>
					<@boxBody>
						<@h level=2>${document.id} - ${document.title}</@h>
						<dl>
							<dt>#i18n{document.preview_document.columnTitleType}</dt>
							<dd>${document.type}</dd>
							<dt>#i18n{document.preview_document.columnTitleDateCreation}</dt>
							<#if document.state?has_content>
								<dt>#i18n{document.preview_document.columnTitleState}</dt>
								<dd>${document.state}</dd>
							</#if> 
							<dd>${document.dateCreation}</dd>
							<dt>#i18n{document.preview_document.columnTitleDateModification}</dt>
							<dd>${document.dateModification}</dd>
						</dl>
						<@h level=3 class='h4'>#i18n{document.preview_document.columnTitleDateValidity} fdsfds</@h>
						<#assign dateBegin="">
						<#if document.dateValidityBegin?has_content>
						<#assign dateBegin=document.dateValidityBegin?string("dd/MM/yyyy")>
						</#if>    
						<#assign dateEnd="">
						<#if document.dateValidityEnd?has_content>
						<#assign dateEnd=document.dateValidityEnd?string("dd/MM/yyyy")>
						</#if>                        
						<#assign labelBeginSince="#i18n{document.preview_document.labelDateValidityBeginSince}">
						<#assign labelBegin="#i18n{document.preview_document.labelDateValidityBegin}">
						<#assign labelEndUntil="#i18n{document.preview_document.labelDateValidityEndUntil}">
						<#assign labelEnd="#i18n{document.preview_document.labelDateValidityEnd}">
						<#if dateBegin?has_content && dateEnd?has_content>
						<@p><@icon style='calendar' /> ${labelBegin} <strong>${dateBegin}</strong> ${labelEnd} <strong>${dateEnd}</strong></@p>
						<#elseif ! ( dateBegin?has_content ) && ! ( dateEnd?has_content )>   
						<@alert color='warning'>
						<@icon style='exclamation-triangle' /> #i18n{document.preview_document.labelDateValidityNotDefined}
						</@alert>
						<#elseif dateBegin?has_content && !( dateEnd?has_content )>
						<@p><@icon style='calendar' /> ${labelBeginSince} ${dateBegin}</@p>
						<#elseif ! ( dateBegin?has_content ) && dateEnd?has_content>  
						<@p><@icon style='calendar' /> ${labelEndUntil} ${dateEnd}</@p> 
						</#if>
					</@boxBody>
				</@box>
			</@columns>
			<@columns lg=6>
				<@box>
					<#assign title>
						#i18n{document.manage_document_publishing.labelAvailablePortlet}
						<#if !portlet_filter?? || portlet_filter.displayLatestPortlets>(${label_display_latest_portlets})</#if>
					</#assign>
					<@boxHeader title=title />
					<@boxBody>
						<@tform method='post' action='jsp/admin/plugins/document/ManageDocumentPublishing.jsp'>
							<@input type='hidden' name='id_document' value='${document.id}' />
							<@fieldSet legend='#i18n{document.manage_documents.buttonSearch}'>
							<@formGroup labelFor='portlet_filter_value' labelKey='#i18n{document.manage_document_publishing.labelSearchBy}' hideLabel=['all']>
								<#if portlet_filter??><#assign value = portlet_filter.searchValue /><#else><#assign value = '' /></#if>
								<@input type='text' name='portlet_filter_value' placeHolder='#i18n{document.manage_document_publishing.labelSearchBy}' value=value />
							</@formGroup>
							<@row>
								<@columns md=4>
									<@formGroup labelFor='portlet_filter_type' labelKey='#i18n{document.manage_document_publishing.labelSearchBy}'>
										<@select name='portlet_filter_type' id='portlet_filter_type'>
											<@option value='page_id' selected=(portlet_filter??  && portlet_filter.portletFilterType = 'page_id') label='#i18n{document.manage_document_publishing.labelSearchByIdPage}' />
											<@option value='page_name' selected=( !portlet_filter?? || portlet_filter.portletFilterType = 'page_name') label='#i18n{document.manage_document_publishing.labelSearchByPageName}' />
											<@option value='portlet_name' selected=(portlet_filter?? && portlet_filter.portletFilterType  = 'portlet_name') label='#i18n{document.manage_document_publishing.labelSearchByPortletName}' />
										</@select>
									</@formGroup>
								</@columns>
								<@columns md=4>
									<@formGroup labelFor='order_portlet' labelKey='#i18n{document.manage_document_publishing.labelOrder}'>
										<#if portlet_filter_error??><@alert color='danger'>${portlet_filter_error}</@alert></#if>
										<@select name='order_portlet'>
											<@option value='0' selected=( !order_portlet?? || order_portlet?? && order_portlet = 0) label='#i18n{document.manage_document_publishing.labelDateUpdatePortlet}' />
											<@option value='1' selected=(order_portlet?? && order_portlet = 1) label='#i18n{document.manage_document_publishing.labelPageName}' />
											<@option value='2' selected=(order_portlet?? && order_portlet = 2) label='#i18n{document.manage_document_publishing.labelPageId}' />
											<@option value='3' selected=(order_portlet?? && order_portlet = 3) label='#i18n{document.manage_document_publishing.labelPortletName}' />
										</@select>
									</@formGroup>
								</@columns>
								<@columns md=4>
									<@formGroup labelFor='order_portlet_asc' labelKey='#i18n{portal.util.sort.label}'>
										<@select name='order_portlet_asc'>
											<@option value="0" selected=( !order_portlet_asc?? || order_portlet_asc?? && order_portlet_asc = 0) label='#i18n{document.manage_document_publishing.labelOrderDesc}' />
											<@option value="1" selected=(order_portlet_asc?? && order_portlet_asc = 1) label='#i18n{document.manage_document_publishing.labelOrderAsc}' />
										</@select>
									</@formGroup>
								</@columns>
							</@row>
							<@row class='align-items-center mt-3'>
								<@columns class='d-flex justify-content-end'>
									<@button type='submit' title='#i18n{document.manage_documents.buttonSearch}' buttonIcon='search' />
								</@columns>
								<#if !portlet_filter?? || portlet_filter.displayLatestPortlets>
									<@input type='hidden' name='is_display_latest_portlets' value='false' />
								<#else>
								<@columns>
									<@button type='submit' title='Supprimer le filtre' buttonIcon='times' color='danger' />
									<@input type='hidden' name='is_display_latest_portlets' value='true' />
								</@columns>
								</#if>
							</@row>
							</@fieldSet>
						</@tform>
						<#if document_list_portlet_list?size gt 0 || document_portlet_list?size gt 0 >
							<@tform name='assignDocument' method='post' action='jsp/admin/plugins/document/DoAssignedDocument.jsp'>
							<@input type='hidden' name='id_document' value='${document.id}' />
							<@input type='hidden' name='status" id="status' value='${status_published}' />
							<@row>
								<@columns>
									<@tabs>
										<@tabList>
											<#if !portlet_filter?? ||portlet_filter.displayLatestPortlets>
												<#assign document_list_portlet_active = true />
											<#else>
												<#assign document_list_portlet_active = false />
											</#if>
											<@tabLink active=document_list_portlet_active href='#document_list_portlet' title='#i18n{document.manage_document_publishing.labelAvailableDocumentListPortlet}' />
											
											<#if portlet_filter?? && !portlet_filter.displayLatestPortlets>
												<#assign document_portlet_active = true />
											<#else>
												<#assign document_portlet_active = false />
											</#if>
											<@tabLink active=document_portlet_active href='#document_portlet' title='#i18n{document.manage_document_publishing.labelAvailableDocumentPortlet}' />
										</@tabList> 
										<@tabContent>
											<@tabPanel id='document_list_portlet' active=document_list_portlet_active>
												<#if document_list_portlet_list?size gt 0>
													<@select name='document_list_portlet_ids' default_value='' multiple=10  items=document_list_portlet_list />
												<#else>
													<@alert color='danger'>#i18n{document.manage_document_publishing.messagePortletNotExist}</@alert>
												</#if>
												<@row class='mt-3'>
												<#if permission_assign?exists>
													<@columns>
														<@button id='btnAssign' type='submit' title='#i18n{document.manage_document_publishing.buttonAssignedOnPortlet}' hideTitle=['xs','sm'] buttonIcon='link' />
													</@columns>
													</#if>	                                   		
													<#if permission_publish?exists>
														<@columns>
															<@button type='submit' title='#i18n{document.manage_document_publishing.buttonAssignedAndPublisheOnPortlet}' hideTitle=['xs','sm'] buttonIcon='play' />
														</@columns>
													</#if>
												</@row>
											</@tabPanel>
											<@tabPanel id='document_portlet' active=document_portlet_active>
												<#if document_portlet_list?size gt 0>
													<@p class='fw-bold'>#i18n{document.manage_document_publishing.labelAvailableDocumentPortlet} <small>#i18n{document.manage_document_publishing.labelAvailableDocumentPortletComment}</small></@p>
													<@select name='document_portlet_ids' default_value='' multiple=10 items=document_portlet_list />
												<#else>
													<@alert color='danger'>#i18n{document.manage_document_publishing.messagePortletNotExist}</@alert>
												</#if>
												<@row class='mt-3'>
													<#if permission_assign?exists>
														<@columns>
															<@button id='btnAssign' type='submit' title='#i18n{document.manage_document_publishing.buttonAssignedOnPortlet}' hideTitle=['xs','sm'] buttonIcon='link' />
														</@columns>
														</#if>	                                   		
														<#if permission_publish?exists>
															<@columns>
																<@button type='submit' title='#i18n{document.manage_document_publishing.buttonAssignedAndPublisheOnPortlet}' hideTitle=['xs','sm'] buttonIcon='play' />
															</@columns>
														</#if>
													</@row>
											</@tabPanel>
										</@tabContent>
									</@tabs>
								</@columns>
							</@row>
							</@tform>
						<#else>
							<@alert color='danger'>
								<@icon style='ban' /> <strong>#i18n{document.manage_document_publishing.messagePortletNotExist}</strong>
							</@alert>
						</#if>
					</@boxBody>
				</@box>
			</@columns>
			<@columns lg=4>
				<#if assigned_portlet_list?size gt 0 >
					<@box>
						<@boxHeader title='#i18n{document.manage_document_publishing.labelPublishedPortletList}' />
						<@boxBody>
							<@table>
								<#list assigned_portlet_list as assigned_portlet_publication>
									<@tr>
										<@td><strong><@tag color='info'>${assigned_portlet_publication.portlet.id}</@tag> ${assigned_portlet_publication.portlet.name}</strong></@td>
										<@td params='style="display:flex;"'>
											<#if permission_publish?exists>
												<#if assigned_portlet_publication.publication.status == status_unpublished>
													<@tform method='post' name='publishing' action='jsp/admin/plugins/document/DoAssignedDocument.jsp'>
														<@input type='hidden' name='id_portlet' value='${assigned_portlet_publication.portlet.id}' />
														<@input type='hidden' name='id_document' value='${document.id}' />
														<@input type='hidden' name='status' value='${status_published}' />
														<@button type='submit' title='#i18n{document.manage_document_publishing.buttonPublish}' hideTitle=['all'] buttonIcon='play' color='success' size='sm' />
													</@tform>
												<#else>
													<@tform method='post' name='unpublishing' action='jsp/admin/plugins/document/DoUnAssignedDocument.jsp'>
														<@input type='hidden' name='id_portlet' value='${assigned_portlet_publication.portlet.id}' />
														<@input type='hidden' name='status' value='${assigned_portlet_publication.publication.status}' />	
														<@input type='hidden' name='id_document' value='${document.id}' />
														<@button type='submit' title='#i18n{document.manage_document_publishing.buttonUnPublish}' hideTitle=['all'] buttonIcon='stop' color='warning' size='sm' />
													</@tform>
												</#if>
											</#if>
											<#if permission_assign?exists>
												<@tform class='ms-1' method='post' name='unassignDocument' action='jsp/admin/plugins/document/DoUnAssignedDocument.jsp'>
													<@input type='hidden' name='id_document' value='${document.id}' />
													<@input type='hidden' name='id_portlet' value='${assigned_portlet_publication.portlet.id}' />
													<@input type='hidden' name='status' value='${status_unpublished}' />
													<@button type='submit' title='#i18n{document.manage_document_publishing.labelUnAssigned}' hideTitle=['all'] buttonIcon='unlink' size='sm' />
												</@tform>
												<@tform class='ms-1' method='post' name='managePublishing' action='jsp/admin/plugins/document/ManagePublishing.jsp'>
													<@input type='hidden' name='id_portlet' value='${assigned_portlet_publication.portlet.id}' />
													<@button type='submit' title='#i18n{document.manage_document_publishing.labelManagePortlet}' hideTitle=['all'] buttonIcon='settings' size='sm' />
												</@tform>
											</#if>
										</@td>
									</@tr>
								</#list>
							</@table>
						</@boxBody>
					</@box>
				<#else>	
					<@box>
						<@boxHeader title='#i18n{document.manage_document_publishing.labelPublishedPortletList}' />
						<@boxBody>
							<@alert color='warning'>
								<@icon style='exclamation-triangle' />
								<strong>#i18n{document.manage_document_publishing.messageDocumentNotAffectedOrPublished}</strong>
							</@alert>
						</@boxBody>
					</@box>
				</#if>
			</@columns>
		</@row>
	</@pageColumn>
</@pageContainer>
</#if>
<script> 
document.addEventListener('DOMContentLoaded', function() {
	const btnAssign = document.getElementById('btnAssign');
	if (btnAssign) {
		btnAssign.addEventListener('click', function() {
			document.getElementById('status').value = "${status_unpublished}";
		});
	}
	
	const displayLatestTrue = document.getElementById('is_display_latest_portlets_true');
	if (displayLatestTrue) {
		displayLatestTrue.addEventListener('click', function() {
			const advancedSearch = document.getElementById('advanced-search');
			if (advancedSearch) {
				advancedSearch.classList.add('d-none');
			}
		});
	}
	
	const displayLatestFalse = document.getElementById('is_display_latest_portlets_false');
	if (displayLatestFalse) {
		displayLatestFalse.addEventListener('click', function() {
			const advancedSearch = document.getElementById('advanced-search');
			if (advancedSearch) {
				advancedSearch.classList.remove('d-none');
			}
		});
	}
	
	const advancedSearch = document.getElementById('advanced-search');
	if (advancedSearch) {
		<#if portlet_filter?? && !portlet_filter.displayLatestPortlets>
			advancedSearch.classList.remove('d-none');
		<#else>
			advancedSearch.classList.add('d-none');
		</#if>
	}
});
</script>