<@pageContainer>
    <@pageColumn>
		<@pageHeader title='#i18n{document.adminFeature.documents_management.name}' class='col-md-3 col-lg-3'>
		<#if space?has_content && space.documentCreationAllowed >
			<#if document_types_list?has_content>
				<@tform method='get' name='CreateDocument' action='jsp/admin/plugins/document/CreateDocument.jsp' class='me-auto'>
					<@formGroup labelFor='document_type_code' labelKey='#i18n{document.manage_documents.labelCreate}' >
						<@inputGroup>
							<@select name='document_type_code' default_value='' items=document_types_list />
							<@button type='submit' title='#i18n{document.manage_documents.buttonCreate}' buttonIcon='plus' hideTitle=['all'] />
						</@inputGroup>
					</@formGroup>
					<#if is_files2docs_plugin_active?has_content && is_files2docs_plugin_active>
						<@button type='button' title='#i18n{document.manage_documents.buttonImport}' id='importLinkButton' buttonIcon='plus-circle' /> 
					</#if>
				</@tform>                                                                
			</#if>
		</#if>
		<@tform method='post' id='SearchDocumentById' name='SearchDocumentById' action='jsp/admin/plugins/document/DoSearchDocumentById.jsp'>
				<@formGroup labelFor='id_document' labelKey='#i18n{document.manage_documents.buttonSearch}' helpKey='#i18n{document.manage_documents.labelSearchById}'>
				<@inputGroup>
					<@input type='text' id='id_document' name='id_document' maxlength=10 />
					<@inputGroupItem>
						<@button type='submit' title='#i18n{document.manage_documents.buttonSearch}' buttonIcon='search' hideTitle=['all'] />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
		</@tform>
		<@tform method='post' id='FullTextSearchDocument' name='FullTextSearchDocument' action='jsp/admin/plugins/document/DocumentSearch.jsp'>
			<@input type='hidden' id='id_document' name='id_document' />
			<@formGroup labelFor='query' labelKey='#i18n{document.manage_documents.buttonSearch}' helpKey='#i18n{document.manage_documents.labelFullTextSearch}'>
				<@inputGroup>
					<@input type='text' id='query' name='query' maxlength=50 />
					<@button type='submit' title='#i18n{document.manage_documents.buttonSearch}' buttonIcon='search' hideTitle=['all'] />
				</@inputGroup>
			</@formGroup>
		</@tform>
		</@pageHeader>
		<@row>
			<@columns sm=4 xl=3>
				<@box>
					<@boxHeader title='#i18n{document.manage_documents.labelSpaces}'>
					<#if space_actions_list?size != 0>
						<#list space_actions_list as space_action>
							<@aButton href='${space_action.url}?id_space=${space.id}' title='${space_action.description}' style='btn btn-action' color='' buttonIcon='${space_action.iconUrl}' hideTitle=['all'] />
						</#list>
					</#if>
					</@boxHeader>
					<@boxBody class='px-0 pb-0'>
					${spaces_tree}
					</@boxBody>
				</@box>
				<#if documents_list?size gt 0 >
				<@box>
				<@boxHeader title='#i18n{document.manage_documents.buttonFilter}' />
					<@boxBody>
					<@tform method='post' name='FilterDocumentsForm' action='jsp/admin/plugins/document/ManageDocuments.jsp'>
						<#if document_types_filter_list?size gt 2 >
						<@formGroup labelFor='document_type_code_filter' labelKey='#i18n{document.manage_documents.labelType}'>
							<@select name='document_type_code_filter' default_value='${default_document_type}' items=document_types_filter_list />
						</@formGroup>
						</#if>
						<@formGroup labelFor='id_state_filter' labelKey='#i18n{document.manage_documents.labelState}'>
							<@inputGroup>
								<@select name='id_state_filter' default_value='${default_state}' items=states_filter_list />
								<@button type='submit' title='#i18n{document.manage_documents.buttonFilter}' buttonIcon='filter' hideTitle=['all'] />
							</@inputGroup>
						</@formGroup>
					</@tform>
					</@boxBody>
				</@box>
				<@box>
					<@boxBody>
					<@tform method='post' name='FilterDocumentsForm' action='jsp/admin/plugins/document/ManageDocuments.jsp'>
					<@formGroup labelFor='view_type' labelKey='#i18n{document.manage_documents.labelViewType}'>
							<@inputGroup>
								<@select name='view_type' default_value='${view_type}' items=view_types_list />
								<@button type='submit' buttonIcon='check' />
							</@inputGroup>
						</@formGroup>
					</@tform>
					</@boxBody>
				</@box>
				</#if>	
				<#if mass_action?has_content && mass_action>
					<@box>
						<@boxHeader title='#i18n{document.manage_documents.labelMoreActions}' />
						<@boxBody>
							<@listGroup>
								<@listGroupItem>
									<@tform type='inline' method='post' id='archiveForm' name='archiveForm' action='jsp/admin/plugins/document/MassArchivalDocument.jsp'>
										<@button class='btn btn-link' type='submit' buttonIcon='file-archive' title='#i18n{document.manage_document.mass_archival_labelBtn}' />
									</@tform>
								</@listGroupItem>
							</@listGroup>
						</@boxBody>
					</@box>
				</#if>
			</@columns>
			<@columns sm=8 xl=9>
			<#if space?has_content>
				<#if documents_list?size = 0>
					<#if child_spaces_list?size != 0 >
						<@box>
							<@boxHeader title='#i18n{document.manage_documents.childSpacesList}' />
							<@boxBody>
								<@ul class='list-unstyled mb-0'>
									<#list child_spaces_list as child_space>
									<@li>
										<@link href='jsp/admin/plugins/document/ManageDocuments.jsp?id_space_filter=${child_space.id}'>
											<@img url=child_space.iconUrl alt=child_space.description title=child_space.description /> ${child_space.name} <small>${child_space.description}</small>
										</@link>
									</@li>
									</#list>
								</@ul>
							</@boxBody>
						</@box>
					</#if>
					<@empty title='#i18n{document.message.noDocumentInspace}' />
				<#else>
					<#if view_type = 'detail' >
						<@tform id='documents_form' name='documents_form' method='post' action='jsp/admin/plugins/document/DoActionSelectionDocument.jsp'>
							<@manageFeature class=''>
								<@manageFeatureItem align='end'>
									<@manageFeatureItemColumn align='end'>
										<@checkBox id='select_all' orientation='switch' name='select_all' params='style="margin-block-end:0;"' />
										<@formGroup formStyle='' labelFor='selection' rows=2>
											<@inputGroup>
												<@select id='selection' name='selection' disabled=true>
													<@option value='validate' label='#i18n{document.manage_document.validate}' />
													<@option value='submit' label='#i18n{document.manage_document.submit}' />
													<@option value='refuse' label='#i18n{document.manage_document.refuse}' />
													<@option value='remove' label='#i18n{document.manage_document.remove}' />
													<@option value='archive' label='#i18n{document.manage_document.archive}' />
													<@option value='unarchive' label='#i18n{document.manage_document.unarchive}' />
												</@select>
												<@button type='submit' title='#i18n{document.manage_documents.applyToSelection}' buttonIcon='check' hideTitle=['all'] />
											</@inputGroup>
										</@formGroup>
									</@manageFeatureItemColumn>
								</@manageFeatureItem>
								</@manageFeature>
								<@manageFeature class=''>
								<#list documents_list as document >
								<@manageFeatureItem class='document-row searchable' params='data-document="${document.id} ${document.title}"'>
									<@manageFeatureItemColumn>
										<@checkBox id='document_selection' orientation='switch' name='document_selection' value='${document.id}' /> 
										<@p class='text-truncate fw-bold' params='title="${document.title} - id: ${document.id}"'>
										<#assign docTitle=''/>
										<#assign docTitle><#list document.actions?sort_by("idAction") as action><#if action.url?has_content><#if action.idAction == 2 || action.idAction == 9><@link href='${action.url}id_document=${document.id}&id_action=${action.idAction}' title='${action.description} ${document.title}' class='dropdown-item'>${document.title}</@link><#break></#if></#if></#list></#assign>
										<#if docTitle?trim !=''>${docTitle}<#else></#if>${document.title}</@p>
									</@manageFeatureItemColumn>
									<#if document.comment != ''><@manageFeatureItemColumn auto=true><@alert color='info'><@icon style='info-circle' /> ${document.comment}</@alert></@manageFeatureItemColumn></#if>
									<@manageFeatureItemColumn auto=true>
										<@span class='me-2' params='title="#i18n{document.manage_documents.labelDateModification}"'><@icon style='calendar'  /> ${document.dateModification}</@span>
										<#if document.stateId=3>
											<@tag color='success' title='#i18n{document.manage_documents.labelState}' tagIcon='check-circle'>${document.state}</@tag>
										<#else>
											<@tag color='info' title='#i18n{document.manage_documents.labelState}' tagIcon='times'>${document.state}
											</@tag>
										</#if>
										<#if document.publishedStatus = 0>
											<@tag color='success' class='ms-2' tagIcon='check-circle'>#i18n{document.manage_documents.PublishedStatus}</@tag>
										<#else>
											<@tag color='danger' class='ms-2' tagIcon='times'>#i18n{document.manage_documents.UnPublishedStatus}</@tag>
										</#if>
									</@manageFeatureItemColumn>
									<@manageFeatureItemColumn auto=true>
										<@button type='button' class='btn-action' buttonIcon='dots-vertical fs-2' dropdownMenu=true>
										<#list document.actions?sort_by("idAction") as action>
											<#if action.url?has_content>
												<@link href='${action.url}id_document=${document.id}&id_action=${action.idAction}' class='dropdown-item'><@icon style='${action.iconUrl}' title=action.description />${action.name}</@link>
											</#if>
										</#list>
										</@button>
									</@manageFeatureItemColumn>
								</@manageFeatureItem>
								</#list>
							</@manageFeature>
						</@tform>
					</#if>
					<#if view_type = "thumbnail">
						<@row class='row-cards '>
						<#list documents_list as document >
							<@columns sm=6 lg=4 class='document-row' params='data-document="${document.id} ${document.title}"'>
								<@box id="document_${document.id}" class='card-sm' >
									<@boxHeader>
										<@div class="card-actions btn-actions">
											<#list document.actions?sort_by("idAction") as action>
												<#if action.url?has_content>
													<@aButton href='${action.url}id_document=${document.id}&id_action=${action.idAction}' title='${action.description}' buttonIcon='${action.iconUrl}' color='' style='btn btn-action' hideTitle=['all'] />
												</#if>
											</#list>
										</@div>
									</@boxHeader>
									<@img url=document.thumbnail! class='card-img-top' alt=document.title! title='${document.title} - ${document.type}' />
									<@boxBody>				
										<@h level=3 class='card-title'><#if document.title?length gt 18>${document.title?substring(0,18)}...<#else>${document.title}</#if> - ${document.id}</@h>							
									</@boxBody>
								</@box>
							</@columns>
						</#list>
						</@row>
					</#if>
					<@paginationAdmin paginator=paginator combo=1 />
				</#if>
			</#if>
			</@columns>
		</@row>
	</@pageColumn>
</@pageContainer>
<script type="module">
import LuteceTree from './themes/shared/modules/luteceTree.js';
const tree = document.querySelector("#lutece-tree");
const mapTree = new LuteceTree( tree );
let sessionSpaceId = sessionStorage.getItem('document_space_id');
let spaceid = sessionSpaceId != null ? sessionSpaceId : ${space.id};
// Get space_id from url parameter
const loc = location.search;
if ( spaceid != loc ) {
	if ( loc.indexOf('id_space_filter') > 0 ){
		// Set space_id from url parameter if exists
		spaceid =  loc.slice( loc.lastIndexOf('=') + 1 );
		sessionStorage.setItem('document_space_id', spaceid );
	}
}
mapTree.selectTreeNode( <#noparse>`#node-${spaceid}`</#noparse> )
</script>
<#-- Document Drag and Drop Module -->
<script src="themes/shared/plugins/document/js/documentDragDrop.js"></script>
<script>
/****** Document search ******/
document.querySelector("#FullTextSearchDocument .form-text").textContent = "#i18n{document.manage_documents.labelAllTextSearch}";
document.getElementById("FullTextSearchDocument").addEventListener("submit", function(e) {
	const queryInput = document.querySelector("#FullTextSearchDocument input#query");
	if (!isNaN(queryInput.value) && queryInput.value.trim() !== "") {
		document.querySelector("#FullTextSearchDocument input#id_document").value = queryInput.value;
		this.setAttribute("action", "jsp/admin/plugins/document/DoSearchDocumentById.jsp");
	}
});
document.getElementById("SearchDocumentById").style.display = "none";

/* Filter document list */
document.getElementById("query").addEventListener("keyup", function() {
	const search = document.getElementById("query").value.toLowerCase();
	document.querySelectorAll(".document-row").forEach(function(row) {
		const doc = row.getAttribute("data-document").toLowerCase();
		if (doc.indexOf(search) === -1) {
			row.classList.add("d-none");
		} else {
			row.classList.remove("d-none");
		}
	});
});

/****** Multiple selection ******/
document.getElementById('select_all').addEventListener('click', function() {
	const checkboxes = document.querySelectorAll('input[type="checkbox"]');
	checkboxes.forEach(function(checkbox) {
		checkbox.checked = this.checked;
	}, this);
});

document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
	checkbox.addEventListener('click', function() {
		const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
		const selectionButton = document.getElementById('selection');
		if (selectedCheckboxes.length > 0) {
			selectionButton.removeAttribute('disabled');
		} else {
			selectionButton.setAttribute('disabled', 'disabled');
		}
	});
});
<#if is_files2docs_plugin_active?has_content && is_files2docs_plugin_active>
/* document MASS import redirection */
document.addEventListener('DOMContentLoaded', function() {
	document.getElementById('importLinkButton').addEventListener('click', function() {
		window.location.href = 'jsp/admin/plugins/files2docs/SelectFiles.jsp?browser_selected_space_id=${current_space_id}&document_type_code=' + document.getElementById('document_type_code').value;
	});
});
</#if>
</script>